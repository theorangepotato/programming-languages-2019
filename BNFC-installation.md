# BNFC installation

The [BNFC homepage](http://bnfc.digitalgrammars.com/) is the first place to go, but installation instructions in the [BNFC tutorial](http://bnfc.digitalgrammars.com/tutorial/bnfc-tutorial.html) are out of date, so we need to work a bit to find our way. I will add information here as we go along and learn more about the best way to get this done. Let me know about anything that may be useful to add. 

(Thanks to Andreas Abel for valuable advice.)

## Working under Windows

I don't use Windows, so I am dependent on your feedback to put more information here ...

There are two possibilities:

- Download the [binaries](https://github.com/BNFC/bnfc/releases) and install natively under Windows. Here are some instructions due to Ryan Lindner. Let me know if I should add anything.

  - Install `make`, see http://gnuwin32.sourceforge.net/packages/make.htm 

  - Download JLex and Cup (see below). Be sure to unzip them (google if you don't know how to do this). Write down their directories.

  - Go to your default directory and open your .bash_profile (vi .bash_profile). Edit it to look something like below, using the directories you created:  

        export CLASSPATH=.:/c/Users/ryan/Documents/Java:/c/Users/ryan/Documents/Java/JLex/:/c/Users/ryan/Documents/Java/Cup

    After saving this, be sure to do '. .bash_profile' to reload your bash profile.

  - Now you should be able to run the following commands:

        bnfc -m -java Calc.cf
        make
        echo "23 + 4 * 70" | java Calc/Test


- Install Linux from the Windows store and continue to follow the instructions for Linux/MacOS in the next section ... this maybe preferable as it puts us all on the same page ... specifically there is the Windows Subsystem for Linux (WSL). Any Windows 10 user can install WSL on their pc. <sup>[[1]](#haskell)</sup>

## Working under Linux/MacOS

Installing BNFC under Linux/MacOS requires installing the programming language [Haskell](https://www.haskell.org/) first. You also need the package management system [Cabal](https://www.haskell.org/cabal/), but it is already part of the Haskell platform. So the first step should be:

Download and install the [Haskell platform](https://www.haskell.org/platform/). 

Create a directory in which you want to clone the BNFC github directory and `cd` there in a terminal. Then perform the following commands.

    git clone https://github.com/BNFC/bnfc
    cd bnfc  
    make
    
If you don't have `make` try `sudo apt install make`.

After calling `make` I get a long list of output finishing with

           Configuring BNFC-2.8.3...
           cabal: Encountered missing dependencies:
           doctest >=0.8, hspec -any, temporary -any

           make: *** [internal-tests] Error 1
        
As far as I understand the missing dependencies and the error can be ignored as long as the executable `bnfc` was generated.

Use your file browser to find where the exectuable `bnfc` is. I found it as `bnfc/source/dist/build/bnfc` (the first occurrence of `bnfc` refers to the directory cloned from github, the second occurrence refers to the executable).

Now we need to make sure that the operating system finds bnfc when typing `bnfc` in the terminal. For example, if you enter `bnfc --version` you may get a `command not found` message. We need to make sure that `bnfc` will be "in the path". I collected some information on [setting the PATH variable](https://github.com/alexhkurz/compiler-construction/blob/master/PATH.md). 
 
Now, on entering `bnfc --version` you should see `2.8.3`. (Or some larger number if you are doing this in the future.)

We can now continue with creating a parser for our calculator. This needs the Haskell lexer [Alex](https://www.haskell.org/alex/) and parser [Happy](https://www.haskell.org/happy/). Alex and Happy are part of the Haskell Platform, so you should already have them installed.

    cd examples
    bnfc -m -haskell Calc.cf
    make
    echo "23 + 4 * 70" | ./TestCalc 
    
This should show you that the parser generated by bnfc can parse the expression "23 + 4 * 70". Also check out the official BNFC tutorial for more information.
 
The next step is to create an interpreter that is able to perform computations such as `23 + 4 * 70`. We will learn later more about how this works, now it is just important to get things running. We continue to work in the directory `bnfc/examples` and copy the interpreter into our working directory. 
 
    cp ../document/tutorial/calc/haskell/Interpreter.hs .
  
(You may want to open `Interpreter.hs` in a text editor ... if you have never seen Haskell before, I hope you are impressed by how simple it is ... essentially just 5 lines of code.)

Open `TestCalc.hs` in a text editor, then modify it as discribed in the [slides](http://www.grammaticalframework.org/ipl-book/slides/2-slides-ipl-book.pdf) on page 33 and save it as Calculator.hs. <sup>[[3]](#footnote)</sup> It is important to import the interpreter and replace the main function (also consider that indentation can make a difference in Haskell).
  
    ghc --make Calculator.hs
    echo "1 + 2 * 3" | ./Calculator
    
which should produce the answer `7`.
    
Great, you have successfully compiled and run your first program.

## Installing the Java lexer and parser

Follow [my instructions here](https://github.com/alexhkurz/compiler-construction/blob/master/BNFC-installation-java.md).

---

<a name="haskell">[1]</a>: Thanks to Majid Aziz.

<a name="footnote">[3]</a>: What is going on here? Remember that `TestCalc` printed the abstract syntax tree. The slides show you how to replace the code of the `main` function that printed the abstract syntax tree by code that interpretes the abstract syntax tree. Essentially, interpreting is very similar to printing. In both cases one walks recursively through the abstract syntax tree. For interpreting as opposed to printing, instead of calling the print function, just call the addition function of the host langauge on encountering a node labelled `EAdd` in the tree (imilarly for `EMul`).
